@page
@using PokerBetterUI.Models
@model PokerBetterUI.Pages.IndexModel

@{
    ViewData["Title"] = "Poker Table";

    // Posisi 10 kursi fixed (% dari center)
    var seatPositions = new (double x, double y)[]
    {
(50, 5), (75, 10), (90, 30), (90, 70), (75, 90),
(50, 95), (25, 90), (10, 70), (10, 30), (25, 10)
    };

    // Assign pemain ke kursi sesuai urutan
    var playerSeatMap = new Dictionary<int, PlayerDTO>();
    var players = Model.GameState?.Players ?? new List<PlayerDTO>();

    for (int i = 0; i < players.Count && i < seatPositions.Length; i++)
    {
        playerSeatMap[players[i].SeatIndex] = players[i];
    }

    var canManagePlayers = Model.GameState?.gameState != "InProgress";
}

<div class="poker-background"></div>

<div class="poker-table">
    <h1 class="title">Meja Poker</h1>

    <div class="alert alert-danger text-center" hidden="@string.IsNullOrEmpty(Model.ErrorMessage)">
        @Model.ErrorMessage
    </div>

    @* <form method="post" class="mb-3">
        <button class="btn btn-primary me-2" asp-page-handler="StartRound" disabled="@(!Model.CanStartRound())">Start
            Round</button>
        <button class="btn btn-secondary" asp-page-handler="NextPhase" disabled="@(!Model.CanNextPhase())">Next
            Phase</button>
    </form> *@

    <div class="table-center">
        @if (Model.GameState?.gameState == "InProgress")
        {
            <!-- Tampilkan phase -->
            <div class="game-phase">
                @Model.GameState?.Phase
            </div>
            <!-- Tampilkan community cards -->
            <div id="community-cards" class="community-cards">
                @foreach (var card in Model.CommunityCardImages ?? new List<string> { "back_dark.png", "back_dark.png",
                        "back_dark.png", "back_dark.png", "back_dark.png" })
                {
                    <div class="card-wrapper">
                        <img src="~/lib/cards/@card" class="poker-card" />
                    </div>
                }
            </div>



            <!-- Tampilkan pot -->
            <div class="game-pot">
                <img src="~/lib/icons/chip.png" class="chip-icon" />
                @Model.GameState?.Pot
            </div>
        }
        else
        {
            <!-- Tampilkan tombol Start Round di tengah meja -->
            <div class="start-round-center">
                <form method="post">
                    <button class="btn btn-primary btn-lg" asp-page-handler="StartRound"
                        disabled="@(!Model.CanStartRound())">
                        Start Round
                    </button>
                </form>
            </div>
        }
        <!-- Players -->
        @for (int i = 0; i < seatPositions.Length; i++)
        {
            playerSeatMap.TryGetValue(i, out var player);
            var isCurrent = player != null && Model.GameState?.CurrentPlayer == player.Name;
            var isWinner = player != null &&
            Model.ShowdownState?.Winners?.Contains(player.Name) == true;

            <div class="player-container
                                                                                                                @(isCurrent ? "current-turn" : "")
                                                                                                                @(isWinner ? "winner-player" : "")"
                style="left:@seatPositions[i].x%; top:@seatPositions[i].y%;">

                @* Jika ada player *@
                @if (player != null)
                {
                    @if (isWinner)
                    {
                        <div class="winner-crown">👑</div>
                    }

                    <div class="player-pic"><img src="~/lib/icons/user.png" /></div>
                    <div class="player-name">@player.Name</div>
                    <div class="chips"><img src="~/lib/icons/chip.png" class="chip-icon" /> <span
                            class="chip-count">@player.ChipStack</span></div>

                    <div class="player-hand">
                        @foreach (var card in player.Hand ?? new())
                        {
                            var img = (player.Hand.Count == 2 &&
                            (Model.GameState.CurrentPlayer == player.Name ||
                            (Model.GameState.Phase == "Showdown" && !player.IsFolded)))
                            ? PokerBetterUI.Pages.IndexModel.CardImageMapper.ToImageFile(card)
                            : "back_dark.png";
                            <img src="~/lib/cards/@img" class="player-card" />
                        }
                    </div>

                    @* Tombol Leave / Add Chips hanya saat game belum InProgress *@
                    @if (canManagePlayers)
                    {
                        <div class="player-controls d-flex gap-1 justify-content-center mt-2">
                            <button class="btn btn-sm btn-danger" onclick="leaveSeat('@player.Name')">
                                <i class="bi bi-x-circle"></i> Leave
                            </button>

                            <input type="number" min="1" value="100" class="form-control form-control-sm add-chips-amount"
                                style="width: 70px;" title="Jumlah chip" />

                            <button class="btn btn-sm btn-success btn-add-chips" data-player-name="@player.Name">
                                <i class="bi bi-plus-circle"></i> +Chips
                            </button>
                        </div>
                    }

                    @* Player Actions saat ronde berjalan *@
                    @if (isCurrent && Model.GameState?.gameState == "InProgress")
                    {
                        <div class="player-actions">
                            <form method="post">
                                <input type="hidden" name="ActionPlayer" value="@player.Name" />
                                <input asp-for="Amount" class="form-control form-control-sm mb-1" placeholder="Bet" value=100 />
                                <div class="btn-group" role="group">
                                    @if (Model.GameState?.Pot == 0)
                                    {
                                        <button class="btn btn-primary btn-sm" asp-page-handler="Bet"
                                            disabled="@(!Model.CanBetOrRaise(player))">Bet</button>
                                    }
                                    <button class="btn btn-success btn-sm" asp-page-handler="Raise"
                                        disabled="@(!Model.CanBetOrRaise(player))">Raise</button>
                                    <button class="btn btn-info btn-sm" asp-page-handler="Call"
                                        disabled="@(!Model.CanCall(player))">Call</button>
                                    <button class="btn btn-secondary btn-sm" asp-page-handler="Check"
                                        disabled="@(!Model.CanCheck(player))">Check</button>
                                    <button class="btn btn-danger btn-sm" asp-page-handler="Fold">Fold</button>
                                    <button type="button" class="btn btn-warning btn-sm" onclick="allIn('@player.Name', this)"
                                        disabled="@(!Model.CanAllIn(player))">All-In</button>
                                </div>
                            </form>
                        </div>
                    }
                }
                else
                {
                    @* Jika kursi kosong, tampilkan tombol Join hanya saat game belum InProgress *@
                    @if (canManagePlayers)
                    {
                        <button class="btn btn-success btn-sm" onclick="joinSeat(@i)">Join</button>
                    }
                    else
                    {
                        <div class="player-pic empty-pic"></div>
                    }
                }
            </div>
        }
    </div>

    @* Winner Overlay *@
    @if (Model.ShowdownState != null)
    {
        <div class="winner-overlay" onclick="closeWinnerOverlay()">
            <div class="winner-box" onclick="event.stopPropagation()">
                <div class="winner-title">🏆 WINNER 🏆</div>
                <div class="winner-names">
                    @foreach (var winner in Model.ShowdownState.Winners)
                    {
                        <span>@winner</span>
                    }
                </div>
                <div class="winner-rank">
                    Hand: <strong>@Model.ShowdownState.HandRank</strong>
                </div>
                <div class="winner-message">@Model.ShowdownState.Message</div>
            </div>
        </div>
    }

</div>
<!-- Letakkan sebelum script yang pakai signalR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/8.0.0/signalr.min.js"></script>

<script>
  const connection = new signalR.HubConnectionBuilder()
      .withUrl("http://localhost:5175/pokerHub", { withCredentials: true })
      .configureLogging(signalR.LogLevel.Information)
      .build();

  connection.start()
      .then(() => console.log("✅ SignalR connected"))
      .catch(err => console.error("❌ SignalR connection error:", err));

  // Contoh menerima pesan
  connection.on("ReceiveMessage", (user, message) => {
      console.log(`${user}: ${message}`);
  });


    // JavaScript Card Name Converter (matches C# CardImageMapper)
    function convertCardToFileName(apiCard) {
        if (!apiCard || typeof apiCard !== 'string') {
            return 'back_dark.png';
        }

        const parts = apiCard.split(' of ');
        if (parts.length !== 2) {
            return 'back_dark.png';
        }

        const rankMap = {
            'Two': '2', 'Three': '3', 'Four': '4', 'Five': '5',
            'Six': '6', 'Seven': '7', 'Eight': '8', 'Nine': '9',
            'Ten': '10', 'Jack': 'J', 'Queen': 'Q', 'King': 'K', 'Ace': 'A'
        };

        const suitMap = {
            'Clubs': 'clubs',
            'Diamonds': 'diamonds',
            'Hearts': 'hearts',
            'Spades': 'spades'
        };

        const rank = rankMap[parts[0]];
        const suit = suitMap[parts[1]];

        if (!rank || !suit) {
            return 'back_dark.png';
        }

        return `${suit}_${rank}.png`;
    }

    function updateCommunityCards(cards) {
        const container = document.getElementById('community-cards');
        if (!container) return;

        container.innerHTML = '';
        cards.forEach((card, index) => {
            const wrapper = document.createElement('div');
            wrapper.className = 'card-wrapper';
            wrapper.style.animationDelay = `${index * 0.1}s`;

            const img = document.createElement('img');
            img.src = `/lib/cards/${encodeURIComponent(convertCardToFileName(card))}`;
            img.className = 'poker-card';
            wrapper.appendChild(img);;
            container.appendChild(wrapper);
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById('community-cards');
        if (container) container.classList.add('visible');
    });

    @* async function refreshGameState() {
        try {
            const res = await fetch('/api/gamestate');
            const data = await res.json();
            if (data && data.communityCards) {
                updateCommunityCards(data.communityCards);
            }
        } catch (err) {
            console.error('Error refreshing game state:', err);
        }
    }

    setInterval(refreshGameState, 2000); *@
    async function allIn(playerName, btn) {
        try {
            btn.disabled = true;
            const originalText = btn.textContent;
            btn.textContent = "Processing...";
            const response = await fetch(`http://localhost:5175/api/GameControllerAPI/allin?name=${encodeURIComponent(playerName)}`, { method: 'POST' });
            if (response.ok) window.location.reload();
            else { btn.disabled = false; btn.textContent = originalText; alert("Gagal All-In!"); }
        } catch (err) {
            console.error(err);
            alert("Terjadi error!"); btn.disabled = false; btn.textContent = originalText;
        }
    }

    function joinSeat(seatIndex) {
        const playerName = prompt("Masukkan nama player:");
        if (!playerName) return;

        let chipsInput = prompt("Masukkan jumlah chip (default 1000):", "1000");
        if (chipsInput === null) return; // user cancel
        let chips = parseInt(chipsInput);
        if (isNaN(chips) || chips <= 0) {
            alert("Jumlah chip tidak valid! Gunakan nilai positif.");
            return;
        }

        const url = `http://localhost:5175/api/GameControllerAPI/addPlayer?name=${encodeURIComponent(playerName)}&chips=${chips}&seatIndex=${seatIndex}`;

        fetch(url, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert(data.message);
            })
            .catch(err => alert("Error: " + err));
    }
    function leaveSeat(playerName) {
        if (!playerName) return;
        if (!confirm(`Apakah kamu yakin ingin menghapus player ${playerName}?`)) return;

        const url = `http://localhost:5175/api/GameControllerAPI/removePlayer?name=${encodeURIComponent(playerName)}`;

        fetch(url, { method: 'POST' })
            .then(res => res.json())
            .then(data => {
                if (data.success) location.reload();
                else alert(data.message);
            })
            .catch(err => alert("Error: " + err));
    }

    document.querySelectorAll(".btn-add-chips").forEach(btn => {
        btn.addEventListener("click", async () => {
            const playerName = btn.getAttribute("data-player-name");

            const input = btn.parentElement.querySelector(".add-chips-amount");
            if (!input) return;

            const amount = parseInt(input.value);
            if (isNaN(amount) || amount <= 0) {
                alert("Jumlah chip harus lebih dari 0");
                return;
            }

            try {
                const response = await fetch("http://localhost:5175/api/GameControllerAPI/addchips", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ playerName, amount })
                });

                const data = await response.json();

                if (!response.ok) {
                    alert(data.message || "Gagal menambahkan chip");
                    return;
                }

                const playerContainer = btn.closest(".player-container");
                if (playerContainer) {
                    // Update span chip
                    let chipSpan = playerContainer.querySelector(".chip-count");
                    if (!chipSpan) {
                        const chipsDiv = playerContainer.querySelector(".chips");
                        if (chipsDiv) {
                            chipSpan = document.createElement("span");
                            chipSpan.classList.add("chip-count");
                            chipsDiv.appendChild(chipSpan);
                        }
                    }
                    if (chipSpan) chipSpan.textContent = data.NewChips ?? chipSpan.textContent;

                    // Update hidden input supaya form submit ikut benar
                    const hiddenInput = playerContainer.querySelector(".player-chip-hidden");
                    if (hiddenInput) hiddenInput.value = data.NewChips ?? hiddenInput.value;
                }

                alert(data.message ?? "Berhasil menambahkan chip");
                window.location.reload();

            } catch (err) {
                console.error(err);
                alert("Terjadi kesalahan saat menambahkan chip");
            }
        });
    });





    document.addEventListener("DOMContentLoaded", () => {
        const overlay = document.querySelector('.winner-overlay');
        if (!overlay) return;

        const winners = "@string.Join(",", Model.ShowdownState?.Winners ?? new List<string>())";
        const handRank = "@Model.ShowdownState?.HandRank";
        const showdownKey = `showdown_${winners}_${handRank}`;

        if (localStorage.getItem(showdownKey)) { overlay.remove(); return; }
        localStorage.setItem(showdownKey, "true");

        setTimeout(() => closeWinnerOverlay(), 3000);
    });

    function closeWinnerOverlay() {
        const overlay = document.querySelector('.winner-overlay');
        if (!overlay) return;
        overlay.style.animation = 'fadeOut .4s ease forwards';
        setTimeout(() => overlay.remove(), 400);
    }
    function checkPlayersChips() {
        const startBtn = document.querySelector(".start-round-center button");
        if (!startBtn) return;

        let canStart = true;
        const chipSpans = document.querySelectorAll(".player-container .chip-count");

        chipSpans.forEach(span => {
            const chips = parseInt(span.textContent);
            if (isNaN(chips) || chips <= 0) {
                canStart = false;
            }
        });

        // Disable atau enable tombol Start Round
        startBtn.disabled = !canStart;

        // Opsional: tampilkan alert jika ada player chip 0
        if (!canStart) {
            startBtn.title = "Tidak bisa mulai: ada player dengan chip 0!";
        } else {
            startBtn.title = "";
        }
    }

    // Panggil saat halaman load
    document.addEventListener("DOMContentLoaded", () => {
        checkPlayersChips();
    });

    // Panggil setiap kali ada perubahan chip (misal add-chips)
    document.querySelectorAll(".btn-add-chips").forEach(btn => {
        btn.addEventListener("click", async () => {
            // kode add chips sudah ada...
            // setelah update chip, cek lagi
            setTimeout(checkPlayersChips, 500); // delay supaya DOM update dulu
        });
    });
</script>


<style>
    /* ================= BASE ================= */
    html,
    body {
        margin: 0;
        padding: 0;
        height: 100%;
        font-family: Arial, sans-serif;
    }

    .poker-background {
        width: 100%;
        min-height: 100vh;
        background: url('/lib/bg/bg.jpg') no-repeat center center;
        background-size: cover;
        position: fixed;
        top: 0;
        left: 0;
        z-index: -1;
    }

    .poker-table {
        width: 90%;
        max-width: 1000px;
        margin: auto;
        position: relative;
        padding-top: 20px;
        z-index: 1;
    }

    .title {
        color: gold;
        text-align: center;
        margin-bottom: 10px;
    }

    .alert {
        margin-bottom: 10px;
    }

    /* ================= TABLE ================= */
    .table-center {
        width: 90%;
        max-width: 1000px;
        aspect-ratio: 1/1;
        margin: 40px auto;
        border-radius: 50%;
        background: radial-gradient(ellipse at center, #1f8a43, #0b3d1f);
        box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.6);
        border: 20px solid #8B5A2B;
        position: relative;
        box-sizing: border-box;
    }

    .table-center::before {
        content: "";
        position: absolute;
        inset: -20px;
        border-radius: 50%;
        background: linear-gradient(135deg, #6b3e1e, #8b5a2b, #6b3e1e);
        z-index: -1;
    }

    /* ================= GAME INFO ================= */
    .game-phase {
        position: absolute;
        top: 38%;
        left: 50%;
        transform: translate(-50%, -100%);
        font-weight: bold;
        font-size: 1.3rem;
        color: gold;
        text-shadow: 0 0 8px rgba(255, 215, 0, 0.8);
        letter-spacing: 1px;
        pointer-events: none;
        z-index: 5;
    }

    .game-pot {
        position: absolute;
        top: 58%;
        left: 50%;
        transform: translate(-50%, 0);
        font-size: 1.1rem;
        color: white;
        display: flex;
        align-items: center;
        gap: 6px;
        text-shadow: 0 0 6px rgba(0, 0, 0, 0.8);
        pointer-events: none;
        z-index: 5;
    }

    .game-pot img {
        width: 26px;
        height: 26px;
    }

    @@keyframes potPulse {
        0% {
            transform: translate(-50%, 0) scale(1);
        }

        50% {
            transform: translate(-50%, 0) scale(1.1);
        }

        100% {
            transform: translate(-50%, 0) scale(1);
        }
    }

    .game-pot {
        animation: potPulse 1.5s infinite ease-in-out;
    }

    .start-round-center {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 10;
    }

    .start-round-center .btn-lg {
        font-size: 1.5rem;
        padding: 12px 24px;
    }

    /* ================= COMMUNITY CARDS ================= */
    .community-cards {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -60%);
        display: flex;
        gap: 8px;
        justify-content: center;
        opacity: 1;
        transition: opacity 0.3s ease;
    }

    .community-cards.hidden {
        opacity: 0;
    }

    .community-cards img {
        width: 8vw;
        max-width: 70px;
    }

    /* ================= PLAYERS ================= */
    .player-container {
        position: absolute;
        width: 18%;
        min-width: 100px;
        text-align: center;
        color: white;
        transition: transform .5s ease, z-index .5s ease, box-shadow .5s ease;
    }

    @@keyframes glowPulse {
        0% {
            box-shadow: 0 0 5px silver;
        }

        50% {
            box-shadow: 0 0 20px silver;
        }

        100% {
            box-shadow: 0 0 5px silver;
        }
    }

    .player-container.current-turn {
        transform: translate(-50%, -50%) scale(1.25);
        z-index: 15;
        animation: glowPulse 1.2s infinite ease-in-out;
    }

    .player-container:not(.current-turn) {
        transform: translate(-50%, -50%);
        z-index: 1;
    }

    .player-pic img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
    }

    .player-name {
        font-weight: bold;
    }

    .chips {
        font-size: 12px;
        opacity: .9;
    }

    .chip-icon {
        width: 30px;
        height: 30px;
        margin-right: 4px;
    }

    .player-hand img {
        width: 6vw;
        max-width: 45px;
        margin: 2px;
        transition: transform .5s ease;
    }

    /* ================= PLAYER ACTIONS (FIXED) ================= */
    .player-actions {
        position: relative;
        z-index: 20;
        margin-top: 6px;
        background: rgba(0, 0, 0, 0.65);
        padding: 6px;
        border-radius: 8px;
    }

    /* FLEX GRID DI FORM */
    .player-actions form {
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: center;
    }

    /* BET INPUT */
    .player-actions input.form-control-sm {
        flex: 1 1 100%;
    }

    /* BUTTON DEFAULT */
    .player-actions .btn {
        flex: 1 1 45%;
        min-width: 48px;
        font-size: .7rem;
        padding: 3px 6px;
    }

    /* FORCE BOTTOM ROW */
    .player-actions .btn-danger,
    .player-actions .btn-warning {
        flex: 1 1 100%;
    }

    /* ALL-IN STYLE */
    .player-actions .btn-warning {
        background: linear-gradient(135deg, #ff9800, #ff5722);
        color: black;
        font-weight: bold;
        border: none;
        box-shadow: 0 0 10px rgba(255, 120, 0, .9);
    }

    .player-actions .btn-warning:hover {
        transform: scale(1.05);
    }

    /* ================= WINNER OVERLAY ================= */
    .winner-overlay {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, .6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        animation: fadeIn .6s ease forwards;
    }

    .winner-box {
        background: radial-gradient(circle, #2c7a3f, #0b3d1f);
        border: 4px solid gold;
        padding: 24px 36px;
        border-radius: 20px;
        text-align: center;
        color: gold;
        box-shadow: 0 0 40px rgba(255, 215, 0, .9);
        animation: popWinner .6s ease forwards;
    }

    .winner-title {
        font-size: 2rem;
        font-weight: bold;
        margin-bottom: 12px;
        text-shadow: 0 0 12px gold;
    }

    .winner-names span {
        display: block;
        font-size: 1.5rem;
        color: white;
        margin-bottom: 6px;
    }

    .winner-rank {
        margin-top: 10px;
        font-size: 1.1rem;
    }

    .winner-message {
        margin-top: 8px;
        font-style: italic;
        color: #ffd700;
    }

    .winner-player {
        transform: translate(-50%, -50%) scale(1.35);
        z-index: 20;
        box-shadow: 0 0 35px gold;
    }


    /* ================= ANIMATIONS WINNER ================= */
    @@keyframes popWinner {
        0% {
            transform: scale(.5);
            opacity: 0;
        }

        80% {
            transform: scale(1.1);
        }

        100% {
            transform: scale(1);
            opacity: 1;
        }
    }

    @@keyframes fadeIn {
        from {
            opacity: 0;
        }

        to {
            opacity: 1;
        }
    }

    @@keyframes fadeOut {
        from {
            opacity: 1;
        }

        to {
            opacity: 0;
        }
    }



    /* ================= RESPONSIVE ================= */
    @@media (max-width:768px) {
        .player-container {
            width: 20%;
            font-size: 2.5vw;
        }

        .player-hand img {
            width: 10vw;
            max-width: 35px;
        }

        .community-cards img {
            width: 12vw;
            max-width: 50px;
        }
    }
</style>